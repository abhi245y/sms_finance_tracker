<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Transaction Details</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f8f9fa; /* Off-white background */
            color: #1a1a1a; /* Default dark text */
            padding: 16px;
            padding-bottom: 100px; /* Space for Telegram MainButton */
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 16px; /* Spacing between cards, Fold uses ~16px or sometimes 12px */
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.06); /* Subtle border */
        }

        /* Main transaction card */
        .main-card {
            text-align: center;
            padding: 24px 20px;
            position: relative;
        }

        /* REMOVED .bookmark-icon */

        .amount {
            font-size: 48px;
            font-weight: 700; /* Bold amount */
            color: #1a1a1a;
            margin: 16px 0;
            line-height: 1;
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6; /* Light grey badge background */
            padding: 8px 16px;
            border-radius: 20px; /* Pill shape */
            font-size: 14px;
            font-weight: 500;
            color: #374151; /* Darker grey text */
            margin-top: 12px;
            cursor: pointer;
        }

        .category-badge i {
            width: 16px;
            height: 16px;
        }

        /* Info cards (FROM / ON) */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px; /* Creates the separator line */
            background: #e5e7eb; /* Separator color */
            border-radius: 16px;
            overflow: hidden; /* To clip children to border-radius */
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .info-item {
            background: white;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 500;
            color: #6b7280; /* Grey label */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600; /* Semi-bold value */
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .account-icon { /* For the 'P' icon */
            width: 20px;
            height: 20px;
            background: #3b82f6; /* Blue background */
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 600;
        }

        /* Paid to section */
        .paid-to-card {
            padding: 16px 20px; /* Specific padding */
            cursor: pointer;
        }

        .paid-to-header {
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .paid-to-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .paid-to-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .merchant-icon {
            width: 32px;
            height: 32px;
            background: #f3f4f6; /* Light grey background for icon */
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280; /* Icon color */
        }
        .merchant-icon i {
            width: 18px;
            height: 18px;
        }

        .merchant-name {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .chevron {
            width: 20px;
            height: 20px;
            color: #9ca3af; /* Chevron color */
        }

        /* Action items (Account in, More Details, etc.) */
        .actions-card {
            padding: 0;
            overflow: hidden; 
        }

        .action-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .action-item:hover {
            background-color: #f9fafb; 
        }

        .action-item:not(:last-child) {
            border-bottom: 1px solid #f3f4f6; 
        }

        .action-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-icon {
            width: 20px;
            height: 20px;
            color: #6b7280;
        }

        .action-text {
            font-size: 16px;
            font-weight: 500;
            color: #1a1a1a;
        }

        .action-date {
            font-size: 14px;
            font-weight: 500;
            color: #374151; 
            margin-left: auto;
            padding-right: 8px;
        }
        
        .action-item.no-chevron .action-left {
            flex-grow: 1; 
        }


        /* Notes section */
        .notes-card {
            padding: 0; 
            overflow: hidden;
        }

        .notes-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notes-title-text { 
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .add-receipt-btn {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6; 
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }

        .notes-content {
            padding: 16px 20px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 80px;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 15px;
            color: #374151; 
            resize: none;
            background: transparent;
        }

        .notes-textarea::placeholder {
            color: #9ca3af; 
        }

        /* Toggle switch (Exclude from Cash Flow) */
        .toggle-item-card { 
             padding: 0; 
        }
        .toggle-item {
            display: flex;
            align-items: center; 
            justify-content: space-between;
            padding: 16px 20px;
        }

        .toggle-left {
            display: flex;
            align-items: flex-start; 
            gap: 12px;
            flex: 1; 
        }

        .toggle-icon {
            width: 20px;
            height: 20px;
            color: #6b7280;
            margin-top: 2px; 
        }

        .toggle-content {
            flex: 1;
        }

        .toggle-title {
            font-size: 16px;
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .toggle-subtitle {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.4;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px; 
            height: 24px; 
            flex-shrink: 0; 
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb; 
            transition: 0.2s;
            border-radius: 24px; 
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px; 
            width: 20px;  
            left: 2px;   
            bottom: 2px; 
            background-color: white;
            transition: 0.2s;
            border-radius: 50%; 
        }

        input:checked + .slider {
            background-color: #3b82f6; 
        }

        input:checked + .slider:before {
            transform: translateX(20px); 
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f4f6; 
            border-radius: 50%;
            border-top-color: #3b82f6; 
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Category modal */
        .category-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5); 
            display: none; 
            justify-content: center;
            align-items: flex-end; 
            z-index: 2000;
        }

        .category-content {
            background: white;
            width: 100%;
            max-width: 400px; 
            border-radius: 16px 16px 0 0; 
            max-height: 85vh; 
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .category-header {
            padding: 12px 20px; 
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .category-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            text-align: center;
            flex-grow: 1; 
        }

        .close-btn, .save-btn {
            font-size: 16px;
            font-weight: 600;
            color: #3b82f6; 
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px; 
        }
        .close-btn { font-size: 20px; line-height: 1; } 
        .save-btn { font-size: 22px; line-height: 1; } 


        .transaction-preview {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .preview-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .preview-left .merchant-icon { 
            width: 28px; height: 28px;
        }
        .preview-left .merchant-icon i {
             width: 16px; height: 16px;
        }
        .preview-left .merchant-name { font-size: 14px; font-weight: 500;}


        .preview-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .preview-amount {
            font-size: 16px; 
            font-weight: 700;
            color: #1a1a1a;
        }

        .preview-category-badge { 
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f3f4f6;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
        }
        .preview-category-badge i { width: 12px; height: 12px; }

        .preview-account-icon { 
            width: 18px; height: 18px; font-size: 9px;
        }


        .search-section {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
        }
        .search-input::placeholder { color: #9ca3af; }

        .search-input:focus {
            border-color: #3b82f6; 
        }

        .categories-section {
            padding: 20px;
            flex-grow: 1; 
            overflow-y: auto;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280; 
            margin-bottom: 16px;
        }

        .category-grid { /* For 'Most used' */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
            gap: 12px;
            margin-bottom: 24px;
        }

        .category-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px; 
            background: #f9fafb; 
            border: 1px solid #e5e7eb; 
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .category-chip i { width: 16px; height: 16px; color: #6b7280; }

        .category-chip:hover,
        .category-chip.selected {
            background: #eff6ff; 
            border-color: #3b82f6; 
            color: #1d4ed8; 
        }
        .category-chip.selected i { color: #1d4ed8; }


        .category-list { /* For main list of categories */
            display: flex;
            flex-direction: column;
            gap: 24px; 
        }

        .category-group-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px; 
        }

        .category-group-subtitle {
            font-size: 12px; 
            color: #6b7280;
            margin-bottom: 12px;
        }

        .subcategory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
            gap: 12px;
        }

        .subcategory-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px 6px; 
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.15s ease;
            position: relative;
        }
         .subcategory-item.selected::after { 
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: #3b82f6;
            border-radius: 50%;
        }


        .subcategory-item:hover {
            background: #f9fafb; 
        }

        .subcategory-icon-wrapper { 
            width: 40px; 
            height: 40px;
            background: #f3f4f6; 
            border-radius: 12px; 
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 20px; 
        }
        .subcategory-icon-wrapper i { width: 20px; height: 20px;}


        .subcategory-name {
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            text-align: center;
            line-height: 1.2;
            width: 100%; 
        }

        .subcategory-icon-wrapper .emoji-icon,
        .preview-category-badge .emoji-icon, 
        .category-badge .emoji-icon {
            font-size: 1.2em; 
            line-height: 1;
            vertical-align: middle;
        }

        .subcategory-icon-wrapper img.custom-icon,
        .preview-category-badge img.custom-icon,
        .category-badge img.custom-icon{
            width: 20px; 
            height: 20px;
            vertical-align: middle;
        }

        .category-chip .emoji-icon {
            font-size: 1em; 
        }
        .category-chip img.custom-icon {
            width: 16px;
            height: 16px;
        }

    </style>
</head>
<body>
    <main class="container">
        <div class="card main-card">
            <div id="transaction-amount" class="amount">-‚Çπ140</div>
            <div class="category-badge" id="category-badge-main">
                <i data-feather="coffee" id="main-category-icon"></i>
                <span id="main-category-name">FOOD & DRINKS</span>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">FROM</div>
                <div class="info-value">
                    <div class="account-icon" id="from-account-icon-initial">P</div>
                    <span id="from-account-details">***0214</span>
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">ON</div>
                <div class="info-value">
                    <span id="transaction-date">Thu, Jun. 12 '25</span>
                </div>
            </div>
        </div>

        <div class="card paid-to-card" id="paid-to-card-action">
            <div class="paid-to-header">PAID TO</div>
            <div class="paid-to-content">
                <div class="paid-to-info">
                    <div class="merchant-icon">
                        <i data-feather="user"></i>
                    </div>
                    <div id="paid-to-merchant-name" class="merchant-name">JOSE A</div>
                </div>
                <i data-feather="chevron-right" class="chevron"></i>
            </div>
        </div>

        <div class="card actions-card">
            <div class="action-item" id="account-in-action">
                <div class="action-left">
                    <i data-feather="calendar" class="action-icon"></i>
                    <span class="action-text">Account in</span>
                </div>
                <span id="account-in-date" class="action-date">Jun 2025</span>
                <i data-feather="chevron-right" class="chevron"></i>
            </div>
            <div class="action-item" id="more-details-action">
                <div class="action-left">
                    <i data-feather="info" class="action-icon"></i>
                    <span class="action-text">More Details</span>
                </div>
                <i data-feather="chevron-right" class="chevron"></i>
            </div>
        </div>


        <!-- Notes -->
        <div class="card notes-card">
            <div class="notes-header">
                <div class="notes-title-text">NOTES</div>
                <button class="add-receipt-btn">ADD RECEIPT</button>
            </div>
            <div class="notes-content">
                <textarea id="description" class="notes-textarea" placeholder="Something about this transaction you would like to recall later?"></textarea>
            </div>
        </div>

        <!-- Cash Flow Toggle -->
        <div class="card toggle-item-card">
            <div class="toggle-item">
                <div class="toggle-left">
                    <i data-feather="trending-down" class="toggle-icon"></i>
                    <div class="toggle-content">
                        <div class="toggle-title">Exclude from Cash Flow</div>
                        <div class="toggle-subtitle">Turn this on if you don't want this expense to affect your cash flow analysis.</div>
                    </div>
                </div>
                <label class="switch" >
                    <input disabled type="checkbox" id="exclude-cashflow-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </main>

    <!-- Category Selection Modal -->
    <div class="category-modal" id="categoryModal">
        <div class="category-content">
            <div class="category-header">
                <button class="close-btn" id="closeModalBtn">‚úï</button>
                <div class="category-title">Tag transaction</div>
                <button class="save-btn" id="saveCategoryBtn">‚úì</button>
            </div>
            
            <div class="transaction-preview">
                <div class="preview-left">
                    <div class="merchant-icon" id="modal-merchant-icon-preview">
                        <i data-feather="user"></i>
                    </div>
                    <div>
                        <div class="merchant-name" id="modal-merchant-name-preview">JOSE A</div>
                        <div style="font-size: 12px; color: #6b7280;" id="modal-transaction-time-preview">Yesterday, 5:39PM</div>
                    </div>
                </div>
                <div class="preview-right">
                    <div class="preview-amount" id="modal-amount-preview">-‚Çπ140</div>
                    <div class="preview-category-badge" id="modal-category-badge-preview">
                        <i data-feather="coffee" id="modal-category-icon-preview"></i>
                        <span id="modal-category-name-preview">FOOD & DRINKS</span>
                    </div>
                    <div class="account-icon preview-account-icon" id="modal-account-icon-preview">P</div>
                </div>
            </div>

            <div class="search-section">
                <input type="text" id="category-search-input" class="search-input" placeholder="Search Bills, Categories...">
            </div>

            <div class="categories-section">
                <div id="most-used-categories-container">
                    <div class="section-title">Most used</div>
                    <div class="category-grid" id="most-used-category-grid">
                        <!-- Most used category chips will be populated here by JS -->
                    </div>
                </div>

                <div class="category-list" id="full-category-list">
                    <!-- Full category groups will be populated here by JS -->
                    <!-- Example structure for one group (to be generated by JS):
                    <div class="category-group" data-group-id="food-drinks">
                        <div class="category-group-title">Food & Drinks</div>
                        <div class="category-group-subtitle">Eating out, Swiggy, Zomato etc.</div>
                        <div class="subcategory-grid">
                            <div class="subcategory-item" data-category-id="1" data-icon-name="utensils">
                                <div class="subcategory-icon-wrapper">üçΩÔ∏è</div>
                                <div class="subcategory-name">Eating out</div>
                            </div>
                        </div>
                    </div>
                    -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';
            const tg = window.Telegram.WebApp;
            if (tg.initDataUnsafe?.user) { 
                tg.expand();
                tg.setHeaderColor('#f8f9fa'); 
                tg.setBackgroundColor('#f8f9fa');
            }

            // --- DOM Elements ---
            const loadingOverlay = document.getElementById('loading-overlay');
            
            const transactionAmountEl = document.getElementById('transaction-amount');
            const mainCategoryIconEl = document.getElementById('main-category-icon');
            const mainCategoryNameEl = document.getElementById('main-category-name');
            const fromAccountIconInitialEl = document.getElementById('from-account-icon-initial');
            const fromAccountDetailsEl = document.getElementById('from-account-details');
            const transactionDateEl = document.getElementById('transaction-date');
            const paidToMerchantNameEl = document.getElementById('paid-to-merchant-name');
            const accountInDateEl = document.getElementById('account-in-date');
            const descriptionTextarea = document.getElementById('description');
            const categoryBadgeMain = document.getElementById('category-badge-main');
            const excludeCashflowToggle = document.getElementById('exclude-cashflow-toggle');

            // Category Modal elements
            const categoryModal = document.getElementById('categoryModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const saveCategoryBtn = document.getElementById('saveCategoryBtn'); 
            const modalMerchantNamePreviewEl = document.getElementById('modal-merchant-name-preview');
            const modalTransactionTimePreviewEl = document.getElementById('modal-transaction-time-preview');
            const modalAmountPreviewEl = document.getElementById('modal-amount-preview');
            const modalCategoryIconPreviewEl = document.getElementById('modal-category-icon-preview'); 
            const modalCategoryNamePreviewEl = document.getElementById('modal-category-name-preview');
            const modalAccountIconPreviewEl = document.getElementById('modal-account-icon-preview');
            const mostUsedCategoryGridEl = document.getElementById('most-used-category-grid');
            const fullCategoryListEl = document.getElementById('full-category-list');
            const categorySearchInputEl = document.getElementById('category-search-input');
            const mostUsedCategoriesContainerEl = document.getElementById('most-used-categories-container');


            // --- STATE ---
            let currentTransaction = null; 
            let access_token = ''; 
            const API_BASE_URL = 'https://finance.arlp.live/api/v1';
            
            let allCategoriesStructured = []; // Stores fetched categories: Array of {id, name, description, icon (for parent if any), display_order, subcategories: [{id, name, icon_name, display_order}]}
            let tempSelectedSubcategoryId = null; // Stores ID of SUBCATEGORY selected in modal
            let dataChangedInModal = { 
                subcategory: false,
            };


            // --- MAIN ---
            async function initialize() {
                setLoading(true);
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    access_token = urlParams.get('token');
                    
                    if (!access_token && !tg.initDataUnsafe?.user) { 
                        console.warn("Access token not found. Running in local mode.");
                        currentTransaction = getMockTransactionWithSubcategory();
                        allCategoriesStructured = getMockStructuredCategories(); 
                    } else if (!access_token && tg.initDataUnsafe?.user) {
                         throw new Error("Access token not found.");
                    } else {
                        [currentTransaction, allCategoriesStructured] = await Promise.all([
                            fetchTransactionAPI(),
                            fetchAllCategoriesDetailsAPI() 
                        ]);
                    }
                    
                    // Initialize tempSelectedSubcategoryId from current transaction
                    if (currentTransaction.subcategory && currentTransaction.subcategory.id) {
                        tempSelectedSubcategoryId = currentTransaction.subcategory.id;
                    } else {
                         // Find the "Uncategorized" subcategory under "General" from allCategoriesStructured
                        const generalCat = allCategoriesStructured.find(c => c.name.toLowerCase() === 'general');
                        if (generalCat && generalCat.subcategories) {
                            const uncategorizedSub = generalCat.subcategories.find(sc => sc.name.toLowerCase() === 'uncategorized');
                            if (uncategorizedSub) {
                                tempSelectedSubcategoryId = uncategorizedSub.id;
                                if (!currentTransaction.subcategory) { 
                                    currentTransaction.subcategory = { ...uncategorizedSub, parent_category_name: generalCat.name };
                                }
                            }
                        }
                    }

                    populateUI(currentTransaction);
                    configureMainButton(); 
                    setupEventListeners();
                } catch (error) {
                    console.error("Initialization error:", error);
                    showError(error.message);
                } finally {
                    setLoading(false);
                    feather.replace({ width: '1em', height: '1em', 'stroke-width': 1.8 }); 
                }
            }
            
            function getMockTransactionWithSubcategory() {
                return {
                    unique_hash: 'mock_hash_123',
                    merchant_vpa: 'MOCK MERCHANT A',
                    amount: 140.00,
                    description: 'Mock tea at office',
                    subcategory: { id: 1101, name: 'Tea & Coffee', icon_name: 'emoji:‚òï', parent_category_id: 101, parent_category_name: 'Food & Drinks' }, 
                    account: { id:1, name: 'MockBank', account_last4: '0214', type_initial: 'M', account_type: 'SAVINGS_ACCOUNT' }, 
                    transaction_datetime_from_sms: new Date().toISOString(), 
                    exclude_from_cashflow: false,
                    currency: 'INR', status: 'processed', raw_sms_content: 'mock sms', received_at: new Date().toISOString(),
                    subcategory_id: 1101,
                    account_id: 1
                };
            }

            function getMockStructuredCategories() {
                return [
                    { id: 100, name: 'General', description: 'Default items', display_order: 999, subcategories: [
                        {id: 1000, name: 'Uncategorized', icon_name: 'fthr:tag', display_order: 0, parent_category_id: 100},
                    ]},
                    { id: 101, name: 'Food & Drinks', description: 'Eating out, Swiggy, Zomato etc.', display_order: 0, subcategories: [
                        {id: 1101, name: 'Eating out', icon_name: 'emoji:üçΩÔ∏è', display_order: 0, parent_category_id: 101},
                        {id: 1102, name: 'Tea & Coffee', icon_name: 'emoji:‚òï', display_order: 1, parent_category_id: 101},
                    ]},
                    { id: 102, name: 'Groceries', description: 'Supermarket, daily needs', display_order: 1, subcategories: [
                        {id: 1201, name: 'Staples', icon_name: 'fthr:archive', display_order: 0, parent_category_id: 102},
                    ]},
                ];
            }

            // --- API ---
            async function fetchTransactionAPI() {
                const response = await fetch(`${API_BASE_URL}/transactions/get/by-token`, {
                    headers: { 'Authorization': `Bearer ${access_token}` },
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(`API Error fetching transaction: ${errorData.detail || response.statusText}`);
                }
                const txnData = await response.json();

                if (!txnData.subcategory) { 
                    const generalCat = allCategoriesStructured.find(c => c.name.toLowerCase() === 'general') || {name: 'General'};
                    const uncategorizedSub = generalCat.subcategories ? generalCat.subcategories.find(sc => sc.name.toLowerCase() === 'uncategorized') : null;
                    txnData.subcategory = uncategorizedSub 
                        ? { ...uncategorizedSub, parent_category_name: generalCat.name, parent_category_id: generalCat.id }
                        : { id: null, name: 'Uncategorized', icon_name: 'fthr:circle', parent_category_name: 'General', parent_category_id: null};
                    if (uncategorizedSub) txnData.subcategory_id = uncategorizedSub.id;
                }
                return txnData;
            }

            async function fetchAllCategoriesDetailsAPI() {
                const response = await fetch(`${API_BASE_URL}/categories/all_details`, {
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(`API Error fetching categories: ${errorData.detail || response.statusText}`);
                }
                return await response.json();
            }

            async function updateTransactionAPI(patchData) { 
                const response = await fetch(`${API_BASE_URL}/transactions/by-token`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${access_token}` 
                    },
                    body: JSON.stringify(patchData),
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(`API Error: ${errorData.detail || response.statusText}`);
                }
                return await response.json();
            }

            // --- UI HELPERS ---
            function setLoading(isLoading) {
                loadingOverlay.style.display = isLoading ? 'flex' : 'none';
            }

            function showError(message) {
                if (tg.initDataUnsafe?.user) {
                    tg.showAlert(message);
                } else {
                    alert(message); // Fallback for local testing
                }
                if (tg.MainButton) tg.MainButton.hide();
            }

            function populateUI(transaction) {
                if (!transaction) return;
                transactionAmountEl.textContent = `-‚Çπ${Math.round(transaction.amount)}`;
                
                if (transaction.subcategory && transaction.subcategory.name) {
                    const displayName = transaction.subcategory.parent_category_name && transaction.subcategory.parent_category_name.toLowerCase() !== 'general'
                        ? `${transaction.subcategory.parent_category_name} (${transaction.subcategory.name})`
                        : transaction.subcategory.name;
                    mainCategoryNameEl.textContent = displayName.toUpperCase();
                    mainCategoryIconEl.setAttribute('data-feather', parseIconName(transaction.subcategory.icon_name).name || 'circle');
                } else {
                    mainCategoryNameEl.textContent = 'UNCATEGORIZED';
                    mainCategoryIconEl.setAttribute('data-feather', 'circle');
                }

                if (transaction.account) {
                    fromAccountDetailsEl.textContent = `***${transaction.account.account_last4}`;
                    const accInitial = transaction.account.type_initial || 
                                       (transaction.account.bank_name ? transaction.account.bank_name.charAt(0).toUpperCase() : 
                                       (transaction.account.name ? transaction.account.name.charAt(0).toUpperCase() : 'A'));
                    fromAccountIconInitialEl.textContent = accInitial;
                } else { 
                    fromAccountDetailsEl.textContent = '***0000';
                    fromAccountIconInitialEl.textContent = 'A';
                }
                
                paidToMerchantNameEl.textContent = transaction.merchant_vpa || 'Unknown Merchant';
                descriptionTextarea.value = transaction.description || '';
                excludeCashflowToggle.checked = transaction.exclude_from_cashflow || false;

                if (transaction.transaction_datetime_from_sms) {
                    const date = new Date(transaction.transaction_datetime_from_sms);
                    transactionDateEl.textContent = date.toLocaleDateString('en-GB', { 
                        weekday: 'short', month: 'short', day: 'numeric', year: '2-digit'
                    }).replace(/,/g, '');

                    accountInDateEl.textContent = date.toLocaleDateString('en-US', {
                        month: 'short', year: 'numeric'
                    });
                } else {
                    transactionDateEl.textContent = 'No Date';
                    accountInDateEl.textContent = 'N/A';
                }
                
                feather.replace({ width: '1em', height: '1em', 'stroke-width': 1.8 }); 
            }
            
            function populateCategoryModalPreview(transaction) {
                if (!transaction) return;
                modalMerchantNamePreviewEl.textContent = transaction.merchant_vpa || 'Unknown';
                modalAmountPreviewEl.textContent = `-‚Çπ${Math.round(transaction.amount)}`;
                
                if (transaction.account) {
                    modalAccountIconPreviewEl.textContent = transaction.account.type_initial || transaction.account.name?.charAt(0).toUpperCase() || 'A';
                } else {
                     modalAccountIconPreviewEl.textContent = 'A';
                }

                if (transaction.transaction_datetime_from_sms) {
                    const date = new Date(transaction.transaction_datetime_from_sms);
                    modalTransactionTimePreviewEl.textContent = date.toLocaleTimeString('en-US', {
                        hour: 'numeric', minute: '2-digit', hour12: true 
                    });
                } else {
                    modalTransactionTimePreviewEl.textContent = "Time N/A";
                }

                // Use tempSelectedSubcategoryId to reflect live changes in modal preview
                let subcatToPreview = null;
                if (tempSelectedSubcategoryId) {
                    for (const parentCat of allCategoriesStructured) {
                        subcatToPreview = parentCat.subcategories.find(sc => sc.id === tempSelectedSubcategoryId);
                        if (subcatToPreview) {
                            subcatToPreview.parent_category_name = parentCat.name;
                            break;
                        }
                    }
                }
                // Fallback to current transaction's subcategory if nothing temporarily selected or found
                if (!subcatToPreview) subcatToPreview = transaction.subcategory;


                if (subcatToPreview && subcatToPreview.name) {
                    const displayName = subcatToPreview.parent_category_name && subcatToPreview.parent_category_name.toLowerCase() !== 'general'
                        ? `${subcatToPreview.parent_category_name} (${subcatToPreview.name})`
                        : subcatToPreview.name;
                    modalCategoryNamePreviewEl.textContent = displayName.toUpperCase();
                    const parsedIcon = parseIconName(subcatToPreview.icon_name);
                    if (parsedIcon.type === 'feather') {
                        modalCategoryIconPreviewEl.outerHTML = `<i data-feather="${parsedIcon.name || 'circle'}" id="modal-category-icon-preview"></i>`;
                    } else if (parsedIcon.type === 'emoji') {
                        modalCategoryIconPreviewEl.outerHTML = `<span id="modal-category-icon-preview" class="emoji-icon">${parsedIcon.name}</span>`;
                    } 
                } else {
                    modalCategoryNamePreviewEl.textContent = 'UNCATEGORIZED';
                    modalCategoryIconPreviewEl.outerHTML = `<i data-feather="circle" id="modal-category-icon-preview"></i>`;
                }
                feather.replace({ width: '1em', height: '1em', 'stroke-width': 1.8 });
            }

            function parseIconName(iconString) {
                if (!iconString) return { type: 'feather', name: 'circle' };
                if (iconString.startsWith('fthr:')) return { type: 'feather', name: iconString.substring(5) };
                if (iconString.startsWith('img:')) return { type: 'image', name: iconString.substring(4) };
                if (iconString.startsWith('emoji:')) return { type: 'emoji', name: iconString.substring(6) };
                const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1F1E0}-\u{1F1FF}]/u;
                if (emojiRegex.test(iconString)) return { type: 'emoji', name: iconString };
                
                return { type: 'feather', name: iconString };
            }

            function createIconElement(iconString) {
                const parsed = parseIconName(iconString);
                if (parsed.type === 'feather') {
                    return `<i data-feather="${parsed.name || 'circle'}"></i>`;
                } else if (parsed.type === 'emoji') {
                    return `<span class="emoji-icon">${parsed.name}</span>`;
                } else if (parsed.type === 'image') {
                    // Assuming images are in a known path e.g., /static/images/icons/
                    return `<img src="/static/images/icons/${parsed.name}" alt="${parsed.name.split('/').pop().split('.')[0]}" class="custom-icon">`;
                }
                return `<i data-feather="circle"></i>`; 
            }


            function populateCategoriesInModal(categoriesToDisplay) {
                mostUsedCategoryGridEl.innerHTML = ''; 
                fullCategoryListEl.innerHTML = ''; 
                
                // TODO: For "Most Used" needs a proper mechanism. For now, skip or use a few from first category.
                // Example: take first 2 subcategories from first 2 parent categories if they exist
                let mostUsedCount = 0;
                if (categoriesToDisplay.length > 0) {
                    mostUsedCategoriesContainerEl.style.display = 'block';
                    for (const parentCat of categoriesToDisplay) {
                        if (parentCat.subcategories && parentCat.subcategories.length > 0) {
                            for (const subCat of parentCat.subcategories.slice(0, 2)) { 
                                if (mostUsedCount >= 4) break; 
                                const chip = document.createElement('div');
                                chip.className = 'category-chip';
                                chip.dataset.subcategoryId = subCat.id;
                                chip.innerHTML = `${createIconElement(subCat.icon_name)} ${subCat.name.toUpperCase()}`;
                                if (subCat.id === tempSelectedSubcategoryId) {
                                    chip.classList.add('selected');
                                }
                                chip.addEventListener('click', handleSubcategorySelection);
                                mostUsedCategoryGridEl.appendChild(chip);
                                mostUsedCount++;
                            }
                        }
                        if (mostUsedCount >= 4) break;
                    }
                } else {
                     mostUsedCategoriesContainerEl.style.display = 'none';
                }


                categoriesToDisplay.forEach(parentCat => {
                    if (parentCat.name.toLowerCase() === 'general' && parentCat.subcategories.some(sc => sc.name.toLowerCase() === 'uncategorized' && sc.id === tempSelectedSubcategoryId)) {
                        // Optionally skip showing "General (Uncategorized)" in the main list if it's the current selection
                        // Or always show it. For now, let's show all.
                    }

                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'category-group';
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'category-group-title';
                    titleDiv.textContent = parentCat.name;
                    groupDiv.appendChild(titleDiv);

                    if(parentCat.description){
                        const subtitleDiv = document.createElement('div');
                        subtitleDiv.className = 'category-group-subtitle';
                        subtitleDiv.textContent = parentCat.description;
                        groupDiv.appendChild(subtitleDiv);
                    }

                    const subcategoryGridDiv = document.createElement('div');
                    subcategoryGridDiv.className = 'subcategory-grid';

                    parentCat.subcategories.forEach(subCat => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'subcategory-item';
                        itemDiv.dataset.subcategoryId = subCat.id;
                        itemDiv.innerHTML = `
                            <div class="subcategory-icon-wrapper">${createIconElement(subCat.icon_name)}</div>
                            <div class="subcategory-name">${subCat.name}</div>
                        `;
                        if (subCat.id === tempSelectedSubcategoryId) {
                            itemDiv.classList.add('selected');
                        }
                        itemDiv.addEventListener('click', handleSubcategorySelection);
                        subcategoryGridDiv.appendChild(itemDiv);
                    });
                    groupDiv.appendChild(subcategoryGridDiv);
                    fullCategoryListEl.appendChild(groupDiv);
                });

                feather.replace({ width: '1em', height: '1em', 'stroke-width': 1.8 });
            }

            function handleSubcategorySelection(event) {
                const clickedItem = event.currentTarget;
                const subcategoryId = parseInt(clickedItem.dataset.subcategoryId);

                document.querySelectorAll('.category-modal .category-chip.selected, .category-modal .subcategory-item.selected')
                    .forEach(el => el.classList.remove('selected'));
                
                clickedItem.classList.add('selected'); 
                const correspondingChip = mostUsedCategoryGridEl.querySelector(`.category-chip[data-subcategory-id="${subcategoryId}"]`);
                if(correspondingChip) correspondingChip.classList.add('selected');


                tempSelectedSubcategoryId = subcategoryId;
                dataChangedInModal.subcategory = true; 
                populateCategoryModalPreview(currentTransaction); 
            }

            // --- TELEGRAM BUTTONS ---
            function configureMainButton() {
                if (!tg.MainButton) return; 
                tg.MainButton.setParams({
                    text: 'SAVE CHANGES',
                    color: '#3b82f6', 
                    text_color: '#ffffff',
                    is_active: true,
                    is_visible: true
                });
                tg.MainButton.onClick(handleSave);
            }

            async function handleSave() { 
                if (tg.MainButton && (!tg.MainButton.isVisible || !tg.MainButton.isActive)) return;
                if (tg.MainButton) tg.MainButton.showProgress();
                setLoading(true);

                try {
                    const patchData = {
                        description: descriptionTextarea.value,
                        exclude_from_cashflow: excludeCashflowToggle.checked
                    };

                    if (dataChangedInModal.subcategory && tempSelectedSubcategoryId !== null) {
                        patchData.subcategory_id = tempSelectedSubcategoryId;
                    }
                    
                    if (Object.keys(patchData).length > 0 || dataChangedInModal.subcategory) { 
                        if (access_token) { 
                            const updatedTxnFromServer = await updateTransactionAPI(patchData);
                            currentTransaction = { ...currentTransaction, ...updatedTxnFromServer }; 
                             if (updatedTxnFromServer.subcategory) {
                                currentTransaction.subcategory = updatedTxnFromServer.subcategory;
                                tempSelectedSubcategoryId = updatedTxnFromServer.subcategory.id; 
                            } else if (tempSelectedSubcategoryId){ 
                                const sc = findSubcategoryById(allCategoriesStructured, tempSelectedSubcategoryId);
                                currentTransaction.subcategory = sc ? {...sc.subcat, parent_category_name: sc.parentCat.name} : null;
                            }

                        } else { 
                            console.log("Local save (mock):", patchData);
                            if (dataChangedInModal.subcategory && tempSelectedSubcategoryId !== null) {
                                const scPair = findSubcategoryById(allCategoriesStructured, tempSelectedSubcategoryId);
                                if (scPair) {
                                    currentTransaction.subcategory = {...scPair.subcat, parent_category_name: scPair.parentCat.name };
                                    currentTransaction.subcategory_id = tempSelectedSubcategoryId;
                                }
                            }
                            currentTransaction.description = descriptionTextarea.value;
                            currentTransaction.exclude_from_cashflow = excludeCashflowToggle.checked;
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                    
                    dataChangedInModal.subcategory = false; 
                    populateUI(currentTransaction); 

                    if (tg.initDataUnsafe?.user) tg.close();
                    else console.log("Changes processed!");

                } catch (error) {
                    console.error("Save error:", error);
                    showError(`Error saving: ${error.message}`);
                } finally {
                    if (tg.MainButton) tg.MainButton.hideProgress();
                    setLoading(false);
                }
            }
            
            function findSubcategoryById(structuredCategories, subcatId) {
                 for (const parentCat of structuredCategories) {
                    const foundSubcat = parentCat.subcategories.find(sc => sc.id === subcatId);
                    if (foundSubcat) {
                        return { subcat: foundSubcat, parentCat: parentCat };
                    }
                }
                return null;
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                categoryBadgeMain.addEventListener('click', () => {
                    if (currentTransaction.subcategory && currentTransaction.subcategory.id) {
                        tempSelectedSubcategoryId = currentTransaction.subcategory.id;
                    } else { 
                        const generalCat = allCategoriesStructured.find(c => c.name.toLowerCase() === 'general');
                        const uncategorizedSub = generalCat?.subcategories.find(sc => sc.name.toLowerCase() === 'uncategorized');
                        tempSelectedSubcategoryId = uncategorizedSub ? uncategorizedSub.id : null;
                    }
                    dataChangedInModal.subcategory = false; 
                    categorySearchInputEl.value = ''; 
                    populateCategoriesInModal(allCategoriesStructured); 
                    populateCategoryModalPreview(currentTransaction); 
                    categoryModal.style.display = 'flex';
                    feather.replace({ width: '1em', height: '1em', 'stroke-width': 1.8 }); 
                });

                closeModalBtn.addEventListener('click', () => {
                    categoryModal.style.display = 'none';
                    dataChangedInModal.subcategory = false; 
                    if (currentTransaction.subcategory && currentTransaction.subcategory.id) {
                       tempSelectedSubcategoryId = currentTransaction.subcategory.id;
                    }
                });

                saveCategoryBtn.addEventListener('click', () => { 
                    categoryModal.style.display = 'none';
                    if (dataChangedInModal.subcategory && tempSelectedSubcategoryId) {
                        const scPair = findSubcategoryById(allCategoriesStructured, tempSelectedSubcategoryId);
                        if(scPair){
                            populateUI({...currentTransaction, subcategory: {...scPair.subcat, parent_category_name: scPair.parentCat.name}});
                        }
                    }
                });

                categoryModal.addEventListener('click', (e) => {
                    if (e.target === categoryModal) {
                        categoryModal.style.display = 'none';
                    }
                })
                
                categorySearchInputEl.addEventListener('input', (e) => {
                     if (e.target === categorySearchInputEl) {
                        categorySearchInputEl.style.display = 'none';
                    }
                 });
            }

            // --- RUN ---
            initialize();
        });
    </script>
</body>
</html>